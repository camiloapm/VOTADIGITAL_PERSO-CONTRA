<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administraci√≥n - Votaci√≥n Escolar</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f1f5f9; color: #1e293b; line-height: 1.6; }
    .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
    
    /* Login */
    .login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .login-box { background: white; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 400px; }
    .login-box h2 { margin-bottom: 1rem; }
    .login-box input { width: 100%; padding: 0.75rem; margin: 0.5rem 0; border: 2px solid #e2e8f0; border-radius: 0.375rem; }
    
    /* Buttons */
    .btn { display: inline-block; padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 600; border: none; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-secondary { background: #64748b; color: white; }
    .btn-info { background: #06b6d4; color: white; }
    .btn-purple { background: #8b5cf6; color: white; }
    
    /* Layout */
    .header { background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .admin-nav { background: #1e293b; padding: 1rem; margin: 0 -1rem 2rem -1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .admin-nav button { background: #334155; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.9rem; }
    .admin-nav button.active { background: #3b82f6; }
    
    .section { display: none; background: white; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem; }
    .section.active { display: block; }
    
    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; border: 2px solid #e2e8f0; }
    .stat-number { font-size: 2.5rem; font-weight: bold; color: #3b82f6; }
    .stat-label { color: #64748b; margin-top: 0.5rem; }
    
    /* Tables */
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 0.5rem; overflow: hidden; margin-top: 1rem; font-size: 0.9rem; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f8fafc; font-weight: 600; }
    
    /* Forms */
    input[type="text"], input[type="file"], input[type="url"], input[type="password"], select { width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 0.375rem; margin: 0.5rem 0; }
    .card { background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
    
    /* Mode selector */
    .mode-selector { margin: 1.5rem 0; }
    .mode-option { display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 0.5rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s; }
    .mode-option:hover { border-color: #93c5fd; background: #eff6ff; }
    .mode-option input[type="radio"] { width: auto; margin: 0; }
    .mode-option.selected { border-color: #3b82f6; background: #dbeafe; }
    .mode-label { font-weight: 600; font-size: 1.05rem; }
    .mode-description { font-size: 0.9rem; color: #64748b; margin-top: 0.25rem; }
    
    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 0.75rem; padding: 2rem; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; }
    
    /* Alerts */
    .alert { padding: 0.75rem 1rem; border-radius: 0.5rem; margin: 0.75rem 0; font-weight: 500; }
    .alert-success { background: #d1fae5; color: #065f46; border: 2px solid #10b981; }
    .alert-error { background: #fee2e2; color: #991b1b; border: 2px solid #ef4444; }
    .alert-warning { background: #fef3c7; color: #92400e; border: 2px solid #f59e0b; }
    .alert-info { background: #dbeafe; color: #1e40af; border: 2px solid: #3b82f6; }
    
    .candidate-photo { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0; }
    .small-note { font-size: 0.85rem; color: #64748b; margin-top: 0.5rem; }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="login-overlay" class="login-overlay">
    <div class="login-box">
      <h2>üîê Acceso Administrativo</h2>
      <p style="color: #64748b; margin-bottom: 1rem;">Ingresa el c√≥digo de administrador</p>
      <input type="password" id="admin-code-input" placeholder="C√≥digo de administrador" autocomplete="off" />
      <button class="btn btn-primary" onclick="login()" style="width: 100%; margin-top: 0.5rem;">Acceder</button>
      <div id="login-error" class="alert alert-error" style="display: none; margin-top: 1rem;"></div>
    </div>
  </div>

  <div class="container" id="admin-panel" style="display: none;">
    <div class="header">
      <h1>üìä Panel de Administraci√≥n</h1>
      <p style="color: #64748b;">Sistema de Votaci√≥n Escolar - Multirol</p>
    </div>

    <nav class="admin-nav">
      <button onclick="showSection('config')" class="active" id="nav-config">‚öôÔ∏è Configuraci√≥n</button>
      <button onclick="showSection('students')" id="nav-students">üë• Estudiantes</button>
      <button onclick="showSection('candidates')" id="nav-candidates">üéØ Candidatos</button>
      <button onclick="showSection('election')" id="nav-election">üó≥Ô∏è Elecci√≥n</button>
      <button onclick="showSection('results')" id="nav-results">üìà Resultados</button>
      <button onclick="showSection('monitor')" id="nav-monitor">üì° Monitoreo</button>
      <button onclick="logout()" style="margin-left: auto;">üö™ Salir</button>
    </nav>

    <!-- CONFIGURACI√ìN -->
    <section id="section-config" class="section active">
      <h2>‚öôÔ∏è Configuraci√≥n General</h2>
      <div class="hr"></div>
      
      <div class="card">
        <h3>üè´ Informaci√≥n del Colegio</h3>
        <label>Nombre del Colegio</label>
        <input type="text" id="school-name" placeholder="Ej: Colegio San Jos√©" />
        <label>URL del Logo (opcional)</label>
        <input type="url" id="school-logo" placeholder="https://ejemplo.com/logo.png" />
        <button class="btn btn-primary" onclick="updateSchoolInfo()">üíæ Guardar</button>
        <div id="school-alert" style="display: none;"></div>
      </div>

      <div class="card">
        <h3>üéØ Modo de Elecci√≥n</h3>
        <p class="small-note">Selecciona qu√© cargos estar√°n disponibles para votaci√≥n. ‚ö†Ô∏è No se puede cambiar una vez iniciada la votaci√≥n.</p>
        <div class="mode-selector">
          <label class="mode-option">
            <input type="radio" name="election-mode" value="personero" checked />
            <div>
              <div class="mode-label">üìã Solo Personero Estudiantil</div>
              <div class="mode-description">Los estudiantes votar√°n √∫nicamente para Personero</div>
            </div>
          </label>
          
          <label class="mode-option">
            <input type="radio" name="election-mode" value="contralor" />
            <div>
              <div class="mode-label">üìä Solo Contralor Estudiantil</div>
              <div class="mode-description">Los estudiantes votar√°n √∫nicamente para Contralor</div>
            </div>
          </label>
          
          <label class="mode-option">
            <input type="radio" name="election-mode" value="both" />
            <div>
              <div class="mode-label">üéØ Personero Y Contralor (Ambos)</div>
              <div class="mode-description">Los estudiantes votar√°n para ambos cargos (votaci√≥n secuencial)</div>
            </div>
          </label>
        </div>
        <div id="mode-note" class="alert alert-info">
          El modo de elecci√≥n se aplicar√° cuando abras la votaci√≥n. Aseg√∫rate de tener candidatos registrados para los cargos seleccionados.
        </div>
      </div>
    </section>

    <!-- ESTUDIANTES -->
    <section id="section-students" class="section">
      <h2>üë• Gesti√≥n de Estudiantes</h2>
      <div class="hr"></div>
      
      <div style="margin-bottom: 1rem;">
        <button class="btn btn-success" onclick="showAddStudentModal()">‚ûï Agregar Estudiante</button>
        <button class="btn btn-info" onclick="showImportModal()">üì§ Importar Excel</button>
        <button class="btn btn-warning" onclick="exportStudents()">üì• Exportar Lista</button>
        <button class="btn btn-secondary" onclick="generateAllQR()">üî≤ Generar QR Todos</button>
        <button class="btn btn-danger" onclick="confirmClearStudents()">üóëÔ∏è Eliminar Todos</button>
      </div>
      
      <div id="students-table-container">
        <p style="text-align: center; padding: 2rem; color: #64748b;">Cargando estudiantes...</p>
      </div>
    </section>

    <!-- CANDIDATOS -->
    <section id="section-candidates" class="section">
      <h2>üéØ Gesti√≥n de Candidatos</h2>
      <div class="hr"></div>
      
      <div style="margin-bottom: 1rem;">
        <button class="btn btn-success" onclick="showAddCandidateModal()">‚ûï Agregar Candidato</button>
      </div>
      
      <div id="candidates-table-container">
        <p style="text-align: center; padding: 2rem; color: #64748b;">Cargando candidatos...</p>
      </div>
    </section>

    <!-- ELECCI√ìN -->
    <section id="section-election" class="section">
      <h2>üó≥Ô∏è Control de Elecci√≥n</h2>
      <div class="hr"></div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div id="election-status-text" class="stat-number">-</div>
          <div class="stat-label">Estado de la Elecci√≥n</div>
        </div>
        <div class="stat-card">
          <div id="election-mode-text" class="stat-number">-</div>
          <div class="stat-label">Modo de Elecci√≥n</div>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 2rem;">
        <button id="btn-open-election" class="btn btn-success" onclick="openElection()" style="font-size: 1.2rem; padding: 1rem 2rem;">
          üü¢ Abrir Votaci√≥n
        </button>
        <button id="btn-close-election" class="btn btn-danger" onclick="closeElection()" style="font-size: 1.2rem; padding: 1rem 2rem; display: none;">
          üî¥ Cerrar Votaci√≥n
        </button>
      </div>
      
      <div id="election-alert" style="display: none; margin-top: 1.5rem;"></div>
      
      <div class="card" style="margin-top: 2rem;">
        <h3>‚ö†Ô∏è Acciones Cr√≠ticas</h3>
        <p class="small-note">Estas acciones afectan la integridad de los datos. √ösalas con precauci√≥n.</p>
        <button class="btn btn-warning" onclick="confirmResetVotes()" style="margin-top: 1rem;">üîÑ Restablecer Votos</button>
        <p class="small-note">Permite que todos los estudiantes vuelvan a votar (borra votos actuales)</p>
      </div>
    </section>

    <!-- RESULTADOS -->
    <section id="section-results" class="section">
      <h2>üìà Resultados</h2>
      <div class="hr"></div>
      
      <div id="results-container">
        <p style="text-align: center; padding: 2rem; color: #64748b;">Cargando resultados...</p>
      </div>
    </section>

    <!-- MONITOREO -->
    <section id="section-monitor" class="section">
      <h2>üì° Monitoreo en Tiempo Real</h2>
      <div class="hr"></div>
      
      <button class="btn btn-primary" onclick="refreshMonitor()">üîÑ Actualizar</button>
      <div id="monitor-container" style="margin-top: 1.5rem;">
        <p style="text-align: center; padding: 2rem; color: #64748b;">Cargando datos de monitoreo...</p>
      </div>
    </section>
  </div>

  <!-- Modal Agregar Estudiante -->
  <div id="modal-add-student" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>‚ûï Agregar Estudiante</h3>
        <button class="modal-close" onclick="closeModal('modal-add-student')">√ó</button>
      </div>
      <label>Nombre Completo</label>
      <input type="text" id="new-student-name" placeholder="Ej: Juan P√©rez Garc√≠a" />
      <label>Grado (1-12)</label>
      <input type="number" id="new-student-grade" min="1" max="12" placeholder="6" />
      <label>Curso (1-9)</label>
      <input type="number" id="new-student-course" min="1" max="9" placeholder="1" />
      <button class="btn btn-success" onclick="addStudent()" style="width: 100%; margin-top: 1rem;">Agregar</button>
      <div id="add-student-alert" style="display: none;"></div>
    </div>
  </div>

  <!-- Modal Agregar Candidato -->
  <div id="modal-add-candidate" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>‚ûï Agregar Candidato</h3>
        <button class="modal-close" onclick="closeModal('modal-add-candidate')">√ó</button>
      </div>
      <label>Cargo</label>
      <select id="new-candidate-role" required>
        <option value="">Selecciona el cargo</option>
        <option value="personero">üìã Personero Estudiantil</option>
        <option value="contralor">üìä Contralor Estudiantil</option>
      </select>
      <label>Nombre Completo</label>
      <input type="text" id="new-candidate-name" placeholder="Ej: Mar√≠a L√≥pez" />
      <label>Partido/Lista (opcional)</label>
      <input type="text" id="new-candidate-party" placeholder="Ej: Lista A" />
      <label>URL de Foto (opcional)</label>
      <input type="url" id="new-candidate-photo" placeholder="https://ejemplo.com/foto.jpg" />
      <button class="btn btn-success" onclick="addCandidate()" style="width: 100%; margin-top: 1rem;">Agregar</button>
      <div id="add-candidate-alert" style="display: none;"></div>
    </div>
  </div>

  <script>
    // ‚ö†Ô∏è CONFIGURACI√ìN - Reemplaza con tus credenciales de Supabase
    const SUPABASE_URL = https://jyutpefwxdzlcwpwiaxd.supabase.co;
    const SUPABASE_ANON_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5dXRwZWZ3eGR6bGN3cHdpYXhkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDg1MjgxMCwiZXhwIjoyMDg2NDI4ODEwfQ.W2pH7UTC9NI2FsCwM1atcLKTj69FvuTYQ_CSaEHFo6c;

    const API_URL = '/api';
    let adminCode = '';
    let electionStatus = 'closed';
    let electionMode = 'personero';

    const $ = (id) => document.getElementById(id);

    async function fetchAPI(endpoint, options = {}) {
      const headers = { 'Content-Type': 'application/json', 'x-admin-code': adminCode, ...options.headers };
      const res = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
      const data = await res.json().catch(() => ({}));
      return { ok: res.ok, data, status: res.status };
    }

    async function login() {
      const code = $('admin-code-input').value.trim();
      if (!code) {
        showAlert('login-error', 'error', 'Ingresa el c√≥digo de administrador');
        return;
      }

      const { ok } = await fetchAPI('/admin/login', {
        method: 'POST',
        body: JSON.stringify({ admin_code: code })
      });

      if (ok) {
        adminCode = code;
        $('login-overlay').style.display = 'none';
        $('admin-panel').style.display = 'block';
        await loadInitialData();
      } else {
        showAlert('login-error', 'error', 'C√≥digo incorrecto');
      }
    }

    function logout() {
      adminCode = '';
      $('admin-panel').style.display = 'none';
      $('login-overlay').style.display = 'flex';
      $('admin-code-input').value = '';
    }

    function showSection(name) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.admin-nav button').forEach(b => b.classList.remove('active'));
      $(`section-${name}`).classList.add('active');
      $(`nav-${name}`).classList.add('active');

      if (name === 'students') loadStudents();
      if (name === 'candidates') loadCandidates();
      if (name === 'election') loadElectionStatus();
      if (name === 'results') loadResults();
      if (name === 'monitor') loadMonitor();
    }

    function showAlert(id, type, msg) {
      const el = $(id);
      el.className = `alert alert-${type}`;
      el.textContent = msg;
      el.style.display = 'block';
    }

    function showModal(id) {
      $(id).classList.add('active');
    }

    function closeModal(id) {
      $(id).classList.remove('active');
    }

    async function loadInitialData() {
      await loadElectionStatus();
      await loadCandidates();
    }

    async function updateSchoolInfo() {
      const name = $('school-name').value;
      const logo = $('school-logo').value;

      const { ok } = await fetchAPI('/config', {
        method: 'POST',
        body: JSON.stringify({ school_name: name, school_logo_url: logo })
      });

      if (ok) {
        showAlert('school-alert', 'success', '‚úÖ Informaci√≥n actualizada');
      } else {
        showAlert('school-alert', 'error', '‚ùå Error al actualizar');
      }
    }

    async function loadStudents() {
      const { ok, data } = await fetchAPI('/admin/students');
      if (!ok) {
        $('students-table-container').innerHTML = '<p style="color: #ef4444;">Error al cargar estudiantes</p>';
        return;
      }

      const students = data.students || [];
      if (students.length === 0) {
        $('students-table-container').innerHTML = '<p style="text-align: center; padding: 2rem; color: #64748b;">No hay estudiantes registrados</p>';
        return;
      }

      let html = '<table><thead><tr><th>Nombre</th><th>Grado</th><th>Curso</th><th>Lista</th><th>C√≥digo</th><th>Vot√≥ Personero</th><th>Vot√≥ Contralor</th><th>Acciones</th></tr></thead><tbody>';
      students.forEach(s => {
        html += `<tr>
          <td>${s.full_name}</td>
          <td>${s.grade}</td>
          <td>${s.course}</td>
          <td>${s.list_number}</td>
          <td><code>${s.access_code}</code></td>
          <td>${s.has_voted_personero ? '‚úÖ' : '‚ùå'}</td>
          <td>${s.has_voted_contralor ? '‚úÖ' : '‚ùå'}</td>
          <td><button class="btn btn-danger" onclick="deleteStudent('${s.id}')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">üóëÔ∏è</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      $('students-table-container').innerHTML = html;
    }

    function showAddStudentModal() {
      $('new-student-name').value = '';
      $('new-student-grade').value = '';
      $('new-student-course').value = '';
      showModal('modal-add-student');
    }

    async function addStudent() {
      const name = $('new-student-name').value.trim();
      const grade = parseInt($('new-student-grade').value);
      const course = parseInt($('new-student-course').value);

      if (!name || !grade || !course) {
        showAlert('add-student-alert', 'error', 'Completa todos los campos');
        return;
      }

      const { ok } = await fetchAPI('/admin/students', {
        method: 'POST',
        body: JSON.stringify({ full_name: name, grade, course })
      });

      if (ok) {
        closeModal('modal-add-student');
        loadStudents();
      } else {
        showAlert('add-student-alert', 'error', 'Error al agregar estudiante');
      }
    }

    async function deleteStudent(id) {
      if (!confirm('¬øEliminar este estudiante?')) return;
      const { ok } = await fetchAPI('/admin/students', {
        method: 'DELETE',
        body: JSON.stringify({ id })
      });
      if (ok) loadStudents();
    }

    async function loadCandidates() {
      const { ok, data } = await fetchAPI('/admin/candidates');
      if (!ok) {
        $('candidates-table-container').innerHTML = '<p style="color: #ef4444;">Error al cargar candidatos</p>';
        return;
      }

      const candidates = data.candidates || [];
      if (candidates.length === 0) {
        $('candidates-table-container').innerHTML = '<p style="text-align: center; padding: 2rem; color: #64748b;">No hay candidatos registrados</p>';
        return;
      }

      let html = '<table><thead><tr><th>Foto</th><th>Nombre</th><th>Partido</th><th>Cargo</th><th>Votos</th><th>Acciones</th></tr></thead><tbody>';
      candidates.forEach(c => {
        const role = c.election_roles ? c.election_roles.display_name : 'N/A';
        const photo = c.photo_url ? `<img src="${c.photo_url}" class="candidate-photo" />` : 'üë§';
        html += `<tr>
          <td>${photo}</td>
          <td>${c.name}</td>
          <td>${c.party || 'Independiente'}</td>
          <td>${role}</td>
          <td>${c.votes}</td>
          <td><button class="btn btn-danger" onclick="deleteCandidate('${c.id}')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">üóëÔ∏è</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      $('candidates-table-container').innerHTML = html;
    }

    function showAddCandidateModal() {
      $('new-candidate-role').value = '';
      $('new-candidate-name').value = '';
      $('new-candidate-party').value = '';
      $('new-candidate-photo').value = '';
      showModal('modal-add-candidate');
    }

    async function addCandidate() {
      const role = $('new-candidate-role').value;
      const name = $('new-candidate-name').value.trim();
      const party = $('new-candidate-party').value.trim();
      const photo = $('new-candidate-photo').value.trim();

      if (!role || !name) {
        showAlert('add-candidate-alert', 'error', 'Completa el cargo y el nombre');
        return;
      }

      const { ok } = await fetchAPI('/admin/candidates', {
        method: 'POST',
        body: JSON.stringify({ name, party, photo_url: photo, role_name: role })
      });

      if (ok) {
        closeModal('modal-add-candidate');
        loadCandidates();
      } else {
        showAlert('add-candidate-alert', 'error', 'Error al agregar candidato');
      }
    }

    async function deleteCandidate(id) {
      if (!confirm('¬øEliminar este candidato?')) return;
      const { ok } = await fetchAPI('/admin/candidates', {
        method: 'DELETE',
        body: JSON.stringify({ id })
      });
      if (ok) loadCandidates();
    }

    async function loadElectionStatus() {
      const { ok, data } = await fetchAPI('/check-status');
      if (ok) {
        electionStatus = data.status;
        electionMode = data.mode || 'personero';
        
        $('election-status-text').textContent = electionStatus === 'open' ? 'üü¢ ABIERTA' : 'üî¥ CERRADA';
        $('election-mode-text').textContent = electionMode === 'personero' ? 'Personero' : (electionMode === 'contralor' ? 'Contralor' : 'Ambos');

        if (electionStatus === 'open') {
          $('btn-open-election').style.display = 'none';
          $('btn-close-election').style.display = 'inline-block';
        } else {
          $('btn-open-election').style.display = 'inline-block';
          $('btn-close-election').style.display = 'none';
        }

        // Actualizar selector de modo
        const modeRadios = document.querySelectorAll('input[name="election-mode"]');
        modeRadios.forEach(r => {
          r.checked = r.value === electionMode;
          r.disabled = electionStatus === 'open';
        });
      }
    }

    async function openElection() {
      const mode = document.querySelector('input[name="election-mode"]:checked')?.value || 'personero';
      
      if (!confirm(`¬øAbrir la votaci√≥n en modo: ${mode === 'personero' ? 'Solo Personero' : (mode === 'contralor' ? 'Solo Contralor' : 'Personero Y Contralor')}?`)) return;

      const { ok, data } = await fetchAPI('/admin/election', {
        method: 'POST',
        body: JSON.stringify({ action: 'open', mode })
      });

      if (ok) {
        showAlert('election-alert', 'success', '‚úÖ Votaci√≥n abierta correctamente');
        await loadElectionStatus();
      } else {
        showAlert('election-alert', 'error', data.error || '‚ùå Error al abrir votaci√≥n');
      }
    }

    async function closeElection() {
      if (!confirm('¬øCerrar la votaci√≥n?')) return;

      const { ok } = await fetchAPI('/admin/election', {
        method: 'POST',
        body: JSON.stringify({ action: 'close' })
      });

      if (ok) {
        showAlert('election-alert', 'success', '‚úÖ Votaci√≥n cerrada correctamente');
        await loadElectionStatus();
      } else {
        showAlert('election-alert', 'error', '‚ùå Error al cerrar votaci√≥n');
      }
    }

    async function confirmResetVotes() {
      if (!confirm('‚ö†Ô∏è Esto eliminar√° todos los votos y permitir√° votar nuevamente. ¬øContinuar?')) return;
      
      const { ok } = await fetchAPI('/admin/reset-votes', { method: 'POST' });
      
      if (ok) {
        alert('‚úÖ Votos restablecidos correctamente');
        await loadElectionStatus();
      } else {
        alert('‚ùå Error al restablecer votos');
      }
    }

    async function confirmClearStudents() {
      if (!confirm('‚ö†Ô∏è ¬øEliminar TODOS los estudiantes? Esta acci√≥n no se puede deshacer.')) return;
      
      const { ok } = await fetchAPI('/admin/clear-students', { method: 'POST' });
      
      if (ok) {
        alert('‚úÖ Estudiantes eliminados');
        loadStudents();
      } else {
        alert('‚ùå Error al eliminar estudiantes');
      }
    }

    async function loadResults() {
      const { ok, data } = await fetchAPI('/results');
      if (!ok) {
        $('results-container').innerHTML = '<p style="color: #ef4444;">Error al cargar resultados</p>';
        return;
      }

      let html = '<div class="stats-grid">';
      html += `<div class="stat-card"><div class="stat-number">${data.totalStudents || 0}</div><div class="stat-label">Total Estudiantes</div></div>`;
      html += `<div class="stat-card"><div class="stat-number">${data.totalVotedPersonero || 0}</div><div class="stat-label">Votaron Personero</div></div>`;
      html += `<div class="stat-card"><div class="stat-number">${data.totalVotedContralor || 0}</div><div class="stat-label">Votaron Contralor</div></div>`;
      html += `<div class="stat-card"><div class="stat-number">${data.participationPersonero || 0}%</div><div class="stat-label">Participaci√≥n Personero</div></div>`;
      html += '</div>';

      // Resultados Personero
      if (data.personeroResults && data.personeroResults.length > 0) {
        html += '<h3 style="margin-top: 2rem;">üìã Resultados - Personero Estudiantil</h3>';
        html += '<table><thead><tr><th>Candidato</th><th>Partido</th><th>Votos</th><th>Porcentaje</th></tr></thead><tbody>';
        data.personeroResults.forEach(r => {
          html += `<tr><td>${r.name}</td><td>${r.party || 'Independiente'}</td><td><strong>${r.votes}</strong></td><td>${r.percentage}%</td></tr>`;
        });
        html += '</tbody></table>';
      }

      // Resultados Contralor
      if (data.contralorResults && data.contralorResults.length > 0) {
        html += '<h3 style="margin-top: 2rem;">üìä Resultados - Contralor Estudiantil</h3>';
        html += '<table><thead><tr><th>Candidato</th><th>Partido</th><th>Votos</th><th>Porcentaje</th></tr></thead><tbody>';
        data.contralorResults.forEach(r => {
          html += `<tr><td>${r.name}</td><td>${r.party || 'Independiente'}</td><td><strong>${r.votes}</strong></td><td>${r.percentage}%</td></tr>`;
        });
        html += '</tbody></table>';
      }

      $('results-container').innerHTML = html;
    }

    async function loadMonitor() {
      const { ok, data } = await fetchAPI('/monitor');
      if (!ok) {
        $('monitor-container').innerHTML = '<p style="color: #ef4444;">Error al cargar monitoreo</p>';
        return;
      }

      let html = '<div class="stats-grid">';
      html += `<div class="stat-card"><div class="stat-number">${data.summary?.total || 0}</div><div class="stat-label">Total Estudiantes</div></div>`;
      html += `<div class="stat-card"><div class="stat-number">${data.summary?.votedPersonero || 0}</div><div class="stat-label">Votaron Personero</div></div>`;
      html += `<div class="stat-card"><div class="stat-number">${data.summary?.votedContralor || 0}</div><div class="stat-label">Votaron Contralor</div></div>`;
      html += `<div class="stat-card"><div class="stat-number">${data.summary?.participationPersonero || 0}%</div><div class="stat-label">Participaci√≥n Personero</div></div>`;
      html += '</div>';

      if (data.grades && data.grades.length > 0) {
        html += '<h3 style="margin-top: 2rem;">Por Grado</h3>';
        html += '<table><thead><tr><th>Grado</th><th>Total</th><th>Votaron Personero</th><th>Votaron Contralor</th><th>Part. Personero</th><th>Part. Contralor</th></tr></thead><tbody>';
        data.grades.forEach(g => {
          html += `<tr><td>Grado ${g.grade}</td><td>${g.total}</td><td>${g.votedPersonero}</td><td>${g.votedContralor}</td><td>${g.participationPersonero}%</td><td>${g.participationContralor}%</td></tr>`;
        });
        html += '</tbody></table>';
      }

      $('monitor-container').innerHTML = html;
    }

    function refreshMonitor() {
      loadMonitor();
    }

    function exportStudents() {
      // Implementar exportaci√≥n a Excel
      alert('Funci√≥n de exportaci√≥n en desarrollo');
    }

    function generateAllQR() {
      alert('Funci√≥n de generaci√≥n de QR en desarrollo');
    }

    function showImportModal() {
      alert('Funci√≥n de importaci√≥n en desarrollo');
    }

    // Mode selector interactivity
    document.querySelectorAll('.mode-option').forEach(option => {
      option.addEventListener('click', function() {
        document.querySelectorAll('.mode-option').forEach(o => o.classList.remove('selected'));
        this.classList.add('selected');
        this.querySelector('input[type="radio"]').checked = true;
      });
    });

    // Enter key on login
    $('admin-code-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') login();
    });
  </script>
</body>
</html>
